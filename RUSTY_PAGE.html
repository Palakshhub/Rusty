<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RUSTY Control Hub</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      height: 100vh;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      color: #1e3a8a;
      position: relative;
    }
    body::before {
      content: "";
      position: absolute;
      inset: 0;
      background: url("https://imgs.search.brave.com/jhCiNAe8GiSI9AlL_vSWaHQP91gydfa-Fu93tqJ44dk/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly90NC5m/dGNkbi5uZXQvanBn/LzE2LzYxLzQyLzM3/LzM2MF9GXzE2NjE0/MjM3MDRfOVRJMzBB/cWdnd0RkZVNDQzNC/VGR4cFVERnM1RFRo/V1EuanBn") center/cover no-repeat;
      filter: blur(4px) brightness(0.9);
      z-index: -2;
    }
    body::after {
      content:"";
      position:absolute;
      inset:0;
      background: rgba(219,234,254,0.4);
      backdrop-filter: blur(4px);
      z-index: -1;
    }
    .panel {
      width: min(920px, 96%);
      max-width: 920px;
      padding: 22px;
      border-radius: 14px;
      text-align: center;
      position: relative;
      z-index: 1;
      display: grid;
      gap: 18px;
      align-items: center;
      justify-items: center;
      grid-template-rows: auto auto 1fr;
    }
    header { color: #1e3a8a; }
    header svg { width: 52px; height: 52px; vertical-align: middle; margin-right: 10px; }
    .controls {
      display:flex;
      gap:18px;
      align-items:center;
      justify-content:center;
      width:100%;
    }
    .joystick-container {
      display: flex;
      justify-content: space-around;
      width: 100%;
      max-width: 640px;
    }
    .joystick {
      position: relative;
      width: 140px;
      height: 140px;
      background: radial-gradient(circle at center,#eff6ff 0%,#dbeafe 100%);
      border-radius: 50%;
      box-shadow: inset 0 0 12px rgba(100,149,237,0.35), 0 6px 20px rgba(0,0,0,0.08);
      display:flex;
      align-items:center;
      justify-content:center;
      -webkit-user-select:none;
      user-select:none;
      touch-action:none;
    }
    .stick {
      width: 62px;
      height: 62px;
      background: linear-gradient(145deg,#60a5fa,#3b82f6);
      border-radius:50%;
      box-shadow: 0 8px 18px rgba(0,0,0,0.25);
      transform: translate(0,0);
      transition: transform 0.12s cubic-bezier(.2,.9,.3,1);
      touch-action:none;
    }
    .row { display:flex; gap:12px; align-items:center; justify-content:center; }
    .status {
      font-size: 0.95rem;
      padding: 8px 12px;
      border-radius: 10px;
      background: rgba(255,255,255,0.6);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    button {
      background-color: #2563eb;
      color: white;
      padding: 12px 18px;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor:pointer;
    }
    button.secondary {
      background: rgba(255,255,255,0.6);
      color: #1e3a8a;
      font-weight:600;
      border-radius:10px;
      padding:10px 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    @media (max-width:640px) {
      .joystick { width: 120px; height:120px; }
      .stick { width:52px; height:52px; }
      .panel { padding:14px; }
    }
  </style>
</head>
<body>
  <div class="panel" role="main">
    <header>
      <div style="display:flex;align-items:center;justify-content:center">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path fill="#2563eb" d="M10 58h44v4H10zM32 4a4 4 0 0 1 4 4v8l8 8-4 4-8-8-8 8-4-4 8-8V8a4 4 0 0 1 4-4zM28 36h8v14h-8z"/></svg>
        <div style="text-align:left">
          <div style="font-size:26px;font-weight:700">RUSTY Control Hub</div>
          <div style="font-size:13px;color:#234;">Dual-Control BLE Interface for Rusty Mech Arm</div>
        </div>
      </div>
    </header>

    <div class="row">
      <div id="connectionStatus" class="status">Not connected</div>
      <button id="connectBtn">ðŸ”Œ Connect ESP32</button>
      <button id="reconnectBtn" class="secondary" style="display:none">Reconnect</button>
    </div>

    <div class="joystick-container">
      <div class="joystick" id="joystickA"><div class="stick" id="stickA"></div></div>
      <div class="joystick" id="joystickB"><div class="stick" id="stickB"></div></div>
    </div>
  </div>

  <script>
    // UUIDs must match the ESP32 sketch
    const SERVICE_UUID = "12345678-1234-5678-1234-56789abcdef0";
    const CHARACTERISTIC_UUID = "abcdef01-1234-5678-1234-56789abcdef0";

    let bluetoothDevice = null;
    let txCharacteristic = null;
    const connectionStatusEl = document.getElementById('connectionStatus');
    const connectBtn = document.getElementById('connectBtn');
    const reconnectBtn = document.getElementById('reconnectBtn');

    // Save last device id for a best-effort reconnect (getDevices API)
    function saveLastDeviceId(id) {
      try { localStorage.setItem('rusty_last_device', id); } catch(e){}
    }
    function getLastDeviceId() {
      try { return localStorage.getItem('rusty_last_device'); } catch(e){ return null; }
    }

    async function requestAndConnect() {
      try {
        // Robust: filter by service UUID (works regardless of device name)
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }],
          optionalServices: [SERVICE_UUID]
        });
        if (!device) return;
        saveLastDeviceId(device.id);
        await connectDevice(device);
      } catch (err) {
        alert("Could not connect: " + (err && err.message ? err.message : err));
        console.error(err);
      }
    }

    async function connectDevice(device) {
      bluetoothDevice = device;
      connectionStatusEl.textContent = "Connecting...";
      try {
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        txCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
        connectionStatusEl.textContent = `Connected: ${device.name || device.id}`;
        connectBtn.style.display = 'none';
        reconnectBtn.style.display = 'inline-block';
        device.addEventListener('gattserverdisconnected', handleDisconnect);
        console.log("Connected to", device);
      } catch (e) {
        txCharacteristic = null;
        connectionStatusEl.textContent = "Not connected";
        console.error("connectDevice error:", e);
        throw e;
      }
    }

    async function handleDisconnect(evt) {
      const device = evt.target;
      console.warn("Device disconnected:", device);
      connectionStatusEl.textContent = "Disconnected â€” retrying...";
      txCharacteristic = null;
      // Try auto-reconnect a few times
      for (let i=0;i<5;i++){
        try {
          await connectDevice(device);
          console.log("Auto-reconnected");
          return;
        } catch(e) {
          await new Promise(r=>setTimeout(r,2000));
        }
      }
      connectionStatusEl.textContent = "Disconnected";
      connectBtn.style.display = 'inline-block';
      reconnectBtn.style.display = 'inline-block';
    }

    // Attempt to auto-reconnect on page load (best-effort)
    window.addEventListener('load', async () => {
      if (!navigator.bluetooth) {
        alert("Web Bluetooth not supported in this browser. Use Chrome/Edge and open over HTTPS or localhost.");
        return;
      }
      const lastId = getLastDeviceId();
      if (lastId && navigator.bluetooth.getDevices) {
        try {
          const devices = await navigator.bluetooth.getDevices();
          const dev = devices.find(d => d.id === lastId);
          if (dev) {
            await connectDevice(dev);
            console.log("Auto-reconnected to stored device");
            return;
          }
        } catch(e){
          console.warn("Auto-reconnect attempt failed", e);
        }
      }
    });

    connectBtn.addEventListener('click', () => requestAndConnect());
    reconnectBtn.addEventListener('click', async () => {
      if (bluetoothDevice && bluetoothDevice.gatt) {
        try { await connectDevice(bluetoothDevice); return; } catch(e){}
      }
      requestAndConnect();
    });

    async function sendCommand(cmd) {
      if (!txCharacteristic) {
        console.warn("No BLE characteristic to send to.");
        return;
      }
      try {
        const enc = new TextEncoder();
        await txCharacteristic.writeValue(enc.encode(cmd));
        // debug
        console.log("Sent BLE:", cmd);
      } catch (e) {
        console.error("Write failed:", e);
      }
    }

    // Joystick handling (A = left, B = right)
    function setupJoystick(joyEl, stickEl, prefix) {
      const maxRange = 44; // px
      let active = false, cx = 0, cy = 0;

      function start(e) {
        active = true;
        const t = (e.touches && e.touches[0]) || e;
        const rect = joyEl.getBoundingClientRect();
        cx = rect.left + rect.width/2;
        cy = rect.top + rect.height/2;
        move(e);
        e.preventDefault();
      }
      function move(e) {
        if (!active) return;
        const t = (e.touches && e.touches[0]) || e;
        let dx = t.clientX - cx;
        let dy = t.clientY - cy;
        const dist = Math.min(Math.hypot(dx,dy), maxRange);
        const ang = Math.atan2(dy,dx);
        const x = Math.cos(ang)*dist;
        const y = Math.sin(ang)*dist;
        stickEl.style.transform = `translate(${x}px, ${y}px)`;

        // 4-way detection
        let cmd = '';
        if (Math.abs(x) > Math.abs(y)) {
          if (x > 18) cmd = prefix + '_RIGHT';
          else if (x < -18) cmd = prefix + '_LEFT';
        } else {
          if (y > 18) cmd = prefix + '_DOWN';
          else if (y < -18) cmd = prefix + '_UP';
        }
        if (cmd) sendCommand(cmd);
      }
      function end(e) {
        active = false;
        stickEl.style.transform = `translate(0,0)`;
        sendCommand(prefix + '_CENTER');
      }

      joyEl.addEventListener('touchstart', start);
      joyEl.addEventListener('mousedown', start);
      document.addEventListener('touchmove', move, {passive:false});
      document.addEventListener('mousemove', move);
      document.addEventListener('touchend', end);
      document.addEventListener('mouseup', end);
    }

    setupJoystick(document.getElementById('joystickA'), document.getElementById('stickA'), 'A');
    setupJoystick(document.getElementById('joystickB'), document.getElementById('stickB'), 'B');
  </script>
</body>
</html>
