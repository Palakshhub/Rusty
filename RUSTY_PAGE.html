<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RUSTY Control Hub</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      height: 100vh;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      color: #1e3a8a;
      position: relative;
    }
    body::before {
      content: "";
      position: absolute;
      inset: 0;
      background: url("https://imgs.search.brave.com/jhCiNAe8GiSI9AlL_vSWaHQP91gydfa-Fu93tqJ44dk/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly90NC5m/dGNkbi5uZXQvanBn/LzE2LzYxLzQyLzM3/LzM2MF9GXzE2NjE0/MjM3MDRfOVRJMzBB/cWdnd0RkZVNDQzNC/VGR4cFVERnM1RFRo/V1EuanBn") center/cover no-repeat;
      filter: blur(4px) brightness(0.9);
      z-index: -2;
    }
    body::after {
      content:"";
      position:absolute;
      inset:0;
      background: rgba(219,234,254,0.4);
      backdrop-filter: blur(4px);
      z-index: -1;
    }
    .panel {
      width: min(920px, 96%);
      max-width: 920px;
      padding: 22px;
      border-radius: 14px;
      text-align: center;
      position: relative;
      z-index: 1;
      display: grid;
      gap: 18px;
      align-items: center;
      justify-items: center;
      grid-template-rows: auto auto 1fr;
    }
    header { color: #1e3a8a; }
    header svg { width: 52px; height: 52px; vertical-align: middle; margin-right: 10px; }
    .joystick-container {
      display: flex;
      justify-content: space-around;
      width: 100%;
      max-width: 640px;
    }
    .joystick {
      position: relative;
      width: 140px;
      height: 140px;
      background: radial-gradient(circle at center,#eff6ff 0%,#dbeafe 100%);
      border-radius: 50%;
      box-shadow: inset 0 0 12px rgba(100,149,237,0.35), 0 6px 20px rgba(0,0,0,0.08);
      display:flex;
      align-items:center;
      justify-content:center;
      -webkit-user-select:none;
      user-select:none;
      touch-action:none;
    }
    .stick {
      width: 62px;
      height: 62px;
      background: linear-gradient(145deg,#60a5fa,#3b82f6);
      border-radius:50%;
      box-shadow: 0 8px 18px rgba(0,0,0,0.25);
      transform: translate(0,0);
      transition: transform 0.1s cubic-bezier(.2,.9,.3,1);
      touch-action:none;
    }
    .row { display:flex; gap:12px; align-items:center; justify-content:center; }
    .status {
      font-size: 0.95rem;
      padding: 8px 12px;
      border-radius: 10px;
      background: rgba(255,255,255,0.6);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    button {
      background-color: #2563eb;
      color: white;
      padding: 12px 18px;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor:pointer;
    }
    button.secondary {
      background: rgba(255,255,255,0.6);
      color: #1e3a8a;
      font-weight:600;
      border-radius:10px;
      padding:10px 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    @media (max-width:640px) {
      .joystick { width: 120px; height:120px; }
      .stick { width:52px; height:52px; }
      .panel { padding:14px; }
    }
  </style>
</head>
<body>
  <div class="panel" role="main">
<header>
  <div style="display:flex;align-items:center;justify-content:center">
    <img src="https://imgs.search.brave.com/xlLvcWKFXu7JpgltzZcGJd7E-WJxtu5PeTvZiBR8lgM/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9jZG4t/aWNvbnMtcG5nLmZs/YXRpY29uLmNvbS8x/MjgvMTQwNC8xNDA0/NjQyLnBuZw" 
         alt="Rusty Logo" 
         style="width:58px;height:58px;margin-right:10px;">
    <div style="text-align:left">
      <div style="font-size:26px;font-weight:700">RUSTY Control Hub</div>
      <div style="font-size:13px;color:#234;">Dual-Control BLE Interface for Rusty Mech Arm</div>
    </div>
  </div>
</header>


    <div class="row">
      <div id="connectionStatus" class="status">Not connected</div>
      <button id="connectBtn">ðŸ”Œ Connect ESP32</button>
      <button id="reconnectBtn" class="secondary" style="display:none">Reconnect</button>
    </div>

    <div class="joystick-container">
      <div class="joystick" id="joystickA"><div class="stick" id="stickA"></div></div>
      <div class="joystick" id="joystickB"><div class="stick" id="stickB"></div></div>
    </div>
  </div>

  <script>
    const SERVICE_UUID = "12345678-1234-5678-1234-56789abcdef0";
    const CHARACTERISTIC_UUID = "abcdef01-1234-5678-1234-56789abcdef0";
    let bluetoothDevice = null;
    let txCharacteristic = null;

    const connectionStatusEl = document.getElementById('connectionStatus');
    const connectBtn = document.getElementById('connectBtn');
    const reconnectBtn = document.getElementById('reconnectBtn');

    async function requestAndConnect() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }],
          optionalServices: [SERVICE_UUID]
        });
        await connectDevice(device);
      } catch (err) {
        alert("Connection failed: " + err);
      }
    }

    async function connectDevice(device) {
      bluetoothDevice = device;
      connectionStatusEl.textContent = "Connecting...";
      const server = await device.gatt.connect();
      const service = await server.getPrimaryService(SERVICE_UUID);
      txCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
      connectionStatusEl.textContent = `Connected: ${device.name || "Rusty Arm"}`;
      connectBtn.style.display = "none";
      reconnectBtn.style.display = "inline-block";
      device.addEventListener("gattserverdisconnected", handleDisconnect);
    }

    async function handleDisconnect() {
      connectionStatusEl.textContent = "Disconnected â€” retrying...";
      txCharacteristic = null;
      try {
        await connectDevice(bluetoothDevice);
      } catch {
        connectionStatusEl.textContent = "Disconnected";
        connectBtn.style.display = "inline-block";
      }
    }

    connectBtn.addEventListener("click", requestAndConnect);
    reconnectBtn.addEventListener("click", requestAndConnect);

    async function sendCommand(cmd) {
      if (!txCharacteristic) return;
      await txCharacteristic.writeValue(new TextEncoder().encode(cmd));
      console.log("Sent:", cmd);
    }

    function setupJoystick(joyEl, stickEl, prefix) {
      const maxRange = 44;
      let activeTouchId = null;
      let centerX = 0, centerY = 0;

      function start(e) {
        const touch = e.changedTouches ? e.changedTouches[0] : e;
        if (activeTouchId !== null) return; // one touch per joystick
        activeTouchId = touch.identifier !== undefined ? touch.identifier : 'mouse';
        const rect = joyEl.getBoundingClientRect();
        centerX = rect.left + rect.width / 2;
        centerY = rect.top + rect.height / 2;
        move(e);
      }

      function move(e) {
        const touches = e.changedTouches ? Array.from(e.changedTouches) : [e];
        for (const t of touches) {
          if (t.identifier !== activeTouchId && activeTouchId !== 'mouse') continue;
          let dx = t.clientX - centerX;
          let dy = t.clientY - centerY;
          const dist = Math.min(Math.hypot(dx, dy), maxRange);
          const ang = Math.atan2(dy, dx);
          const x = Math.cos(ang) * dist;
          const y = Math.sin(ang) * dist;
          stickEl.style.transform = `translate(${x}px, ${y}px)`;
          let cmd = '';
          if (Math.abs(x) > Math.abs(y)) cmd = x > 18 ? `${prefix}_RIGHT` : x < -18 ? `${prefix}_LEFT` : '';
          else cmd = y > 18 ? `${prefix}_DOWN` : y < -18 ? `${prefix}_UP` : '';
          if (cmd) sendCommand(cmd);
        }
      }

      function end(e) {
        const touches = e.changedTouches ? Array.from(e.changedTouches) : [e];
        for (const t of touches) {
          if (t.identifier === activeTouchId || activeTouchId === 'mouse') {
            stickEl.style.transform = `translate(0,0)`;
            sendCommand(`${prefix}_CENTER`);
            activeTouchId = null;
          }
        }
      }

      joyEl.addEventListener("touchstart", start);
      joyEl.addEventListener("mousedown", start);
      document.addEventListener("touchmove", move, { passive: false });
      document.addEventListener("mousemove", move);
      document.addEventListener("touchend", end);
      document.addEventListener("mouseup", end);
    }

    setupJoystick(document.getElementById("joystickA"), document.getElementById("stickA"), "A");
    setupJoystick(document.getElementById("joystickB"), document.getElementById("stickB"), "B");
  </script>
</body>
</html>

